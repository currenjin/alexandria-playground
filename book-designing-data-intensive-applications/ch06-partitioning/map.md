# Ch06 Partitioning

## TL;DR (3문장)
- 파티셔닝(샤딩)은 **데이터를 여러 노드에 분산**하여 처리량과 저장 용량을 확장한다. 핫스팟을 피하는 것이 핵심.
- **키 범위 파티셔닝**은 범위 쿼리에 유리하고, **해시 파티셔닝**은 균등 분산에 유리하다. 복합 키로 둘을 조합할 수 있다.
- **리밸런싱**은 불가피하다. 고정 파티션 수 또는 동적 분할 전략을 선택하고, 무중단 마이그레이션을 설계한다.

## Key Ideas
- **파티션 키 선택**
  - 키 범위(Range): 정렬/범위 쿼리↑, 핫스팟 위험(시간순 데이터 등)
  - 해시(Hash): 균등 분산, 범위 쿼리 불가
  - 복합 키: `(user_id, timestamp)` → user_id로 파티션, timestamp로 정렬
- **핫스팟 완화**
  - 핫 키에 랜덤 접두사/접미사 추가(fan-out)
  - 애플리케이션 레벨 분산(유명인 문제)
- **보조 인덱스와 파티셔닝**
  - 로컬 인덱스(문서 기준): 쓰기 빠름, 읽기 시 scatter-gather
  - 글로벌 인덱스(용어 기준): 읽기 빠름, 쓰기 시 분산 트랜잭션/비동기 갱신
- **리밸런싱 전략**
  - 고정 파티션 수: 노드 추가 시 파티션 재할당만
  - 동적 분할: 파티션 크기 기준 분할/병합
  - 노드 비례: 노드당 고정 파티션 수
- **라우팅(쿼리 라우팅)**
  - 클라이언트 직접 라우팅
  - 라우팅 티어(프록시)
  - 코디네이터(ZooKeeper, etcd)로 메타데이터 관리

## Trade-offs
| 선택 | 장점 | 단점 | 언제 |
|---|---|---|---|
| **키 범위 파티셔닝** | 범위 쿼리 효율↑, 지역성↑ | 핫스팟 위험(시계열 등) | 범위 스캔 주도 워크로드 |
| **해시 파티셔닝** | 균등 분산, 핫스팟↓ | 범위 쿼리 불가(scatter-gather) | 균등 분산 필요, 점 쿼리 주도 |
| **복합 키** | 범위+분산 균형 | 키 설계 복잡 | user별 시계열 등 |
| **로컬 인덱스** | 쓰기 빠름, 단순 | 읽기 scatter-gather | 쓰기 많은 워크로드 |
| **글로벌 인덱스** | 읽기 빠름 | 쓰기 복잡/비동기 지연 | 읽기 많은 워크로드 |
| **고정 파티션 수** | 리밸런싱 단순 | 초기 설정 중요, 유연성↓ | 예측 가능한 성장 |
| **동적 분할** | 자동 확장, 유연 | 분할/병합 오버헤드 | 예측 어려운 성장 |

## Apply to Our Domain (Orders/Dispatch)
- **주문 테이블 파티셔닝**
  - 파티션 키: `user_id` (해시) → 사용자별 균등 분산
  - 복합 키: `(user_id, created_at)` → 사용자별 시간순 정렬/범위 쿼리
- **핫스팟 대응**: 대량 주문 사용자(B2B) 키에 샤드 힌트 접미사 추가 검토
- **보조 인덱스**: `status` 인덱스는 로컬(문서 기준). 상태별 조회 시 scatter-gather 허용.
- **nearbyBaseOrderId**: 키셋 페이징 + 파티션 내 정렬. 파티션 키 포함 쿼리로 단일 파티션 접근.
- **리밸런싱**: 고정 파티션 수(초기 충분히 크게, 예: 256) + 노드 추가 시 재할당.
- **라우팅**: 애플리케이션 레벨 consistent hashing 또는 프록시(Vitess, ProxySQL).

## Metrics & SLO (30일 롤링)
### SLI
- `partition.size_skew`: 파티션 간 크기 편차(max/avg)
- `partition.qps_skew`: 파티션 간 QPS 편차
- `scatter_gather.query_rate`: scatter-gather 쿼리 비율
- `rebalance.duration_ms`: 리밸런싱 소요 시간
- `rebalance.data_moved_gb`: 리밸런싱 시 이동 데이터량

### SLO
- `partition.size_skew < 2x` (최대 파티션이 평균의 2배 이하)
- `partition.qps_skew < 3x`
- `scatter_gather.query_rate < 10%` (대부분 단일 파티션 접근)
- `rebalance.duration_ms < 3600000` (1시간 이내)

## Open Questions
- 현재 주문 데이터의 **핫스팟 키**(대량 주문 사용자)가 존재하는가? 분포 분석 필요.
- 파티션 수를 **초기 몇 개**로 설정할 것인가? (향후 5년 성장 예측 기반)
- `status` 인덱스 scatter-gather가 **p95 지연**에 미치는 영향은?
- 리밸런싱 중 **쓰기 차단 없이** 마이그레이션 가능한 전략은? (이중 쓰기, 백그라운드 복사)
