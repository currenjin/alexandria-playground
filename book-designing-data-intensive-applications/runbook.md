# DDIA 운영 플레이북

분산 데이터 시스템 운영 중 반복적으로 발생하는 장애를 빠르게 탐지하고 복구하기 위한 실행 문서입니다.
월 단위 리허설 절차는 `runbook-drill.md`를 참고합니다.

## 공통 규칙
- 영향 범위가 확인되기 전까지 신규 배포/스키마 변경을 중지한다.
- 장애 대응 중에는 단일 커뮤니케이션 채널(incident room)에서 의사결정을 기록한다.
- 임시 완화 조치와 영구 수정 항목을 분리해 기록한다.

<a id="replication-lag"></a>
## Replication Lag 급증
### 탐지
- `replication_lag_ms.p95` 급등
- `read_your_writes.violation_rate` 증가

### 즉시 조치
1. 읽기 트래픽을 리더로 강제 라우팅한다.
2. 비핵심 읽기 기능(리포트성 조회) 트래픽을 제한한다.
3. 팔로워 노드 I/O 포화 여부를 확인한다.

### 복구
1. 지연 원인(네트워크, 디스크, 장시간 트랜잭션)을 분리한다.
2. 원인 제거 후 팔로워 catch-up 완료 시점까지 리더 라우팅 유지.
3. 단계적으로 읽기 분산을 재개한다.

### 사후 점검
- 지연 재발 임계치 알람 하향 조정
- failover 기준(RPO/RTO) 재확인

<a id="partition-hotspot"></a>
## Partition Hotspot
### 탐지
- `partition.qps_skew` 또는 특정 샤드 CPU만 급증
- 일부 키에 요청 집중

### 즉시 조치
1. 핫 키 대상 레이트 리밋/캐시 강화.
2. 가능하면 핫 키를 임시 분산(접미사 샤딩)한다.

### 복구
1. 파티션 키 분포를 재분석한다.
2. 리밸런싱/재파티셔닝 계획을 수립하고 저부하 시간에 실행한다.

### 사후 점검
- 신규 키 설계 리뷰 체크리스트에 "핫 키 시뮬레이션" 추가

<a id="tx-contention"></a>
## 트랜잭션 경합/교착 급증
### 탐지
- `db.tx.abort_rate`, `db.lock_wait_ms.p95` 급등
- Deadlock 에러 로그 증가

### 즉시 조치
1. 문제가 되는 API 경로 동시 요청을 제한한다.
2. 긴 트랜잭션을 유발하는 배치를 일시 중지한다.

### 복구
1. 교착 쿼리 패턴을 추출하고 락 획득 순서를 통일한다.
2. 필요한 경로만 격리 수준 상향 또는 원자 연산으로 대체한다.

### 사후 점검
- 동시성 회귀 테스트 케이스 추가

<a id="retry-storm"></a>
## Timeout/Retry Storm
### 탐지
- `dep.timeout_rate` 상승과 함께 `dep.retry_rate` 급증
- 상류 QPS 급등 대비 성공률 저하

### 즉시 조치
1. Retry Budget을 강제하고 초과 재시도를 차단한다.
2. 서킷 브레이커를 열어 실패를 빠르게 반환한다.
3. 비멱등 경로 재시도는 즉시 비활성화한다.

### 복구
1. 의존 서비스 지연 원인을 제거한다.
2. 타임아웃/백오프/지터 파라미터를 재튜닝한다.

### 사후 점검
- 홉별 타임아웃 예산 재산정

<a id="consensus-lock"></a>
## 분산 락/합의 계층 이상
### 탐지
- `consensus.leader_election_ms` 증가
- stale leader write 징후 발생

### 즉시 조치
1. 락 의존 쓰기 경로를 보호 모드(읽기 전용 또는 단일 워커)로 전환한다.
2. 펜싱 토큰 검증 실패 요청은 즉시 차단한다.

### 복구
1. 쿼럼 노드 상태와 네트워크 분할 여부를 확인한다.
2. 리더 선출 안정화 후 쓰기 경로를 단계적으로 복원한다.

### 사후 점검
- 락 만료/클럭 스큐 기반 카오스 테스트 추가

<a id="batch-sla"></a>
## 배치 SLA 미준수
### 탐지
- `batch.job.duration_min.p95` 상승
- 마감 시각 내 미완료

### 즉시 조치
1. 필수 배치와 비필수 배치를 분리해 필수 잡 우선 실행.
2. 병목 조인/셔플 단계의 자원 할당을 일시 증설.

### 복구
1. 실패/지연 스테이지를 재실행하고 결과 무결성(diff)을 확인.
2. 조인 전략(Broadcast/Partitioned) 재선정.

### 사후 점검
- 입력량 증가 추세 기반 용량 계획 갱신

<a id="stream-lag"></a>
## 스트림 Consumer Lag 급증
### 탐지
- `stream.lag_ms.p95` 상승
- `checkpoint.duration_ms.p95` 증가

### 즉시 조치
1. 지연을 유발한 연산자/파티션을 식별한다.
2. 외부 호출이 병목이면 타임아웃 단축 + 비동기화 적용.

### 복구
1. 파티션 재분배 또는 병렬도 확장.
2. 상태 크기 축소(윈도우/보존기간 조정) 후 체크포인트 안정화.

### 사후 점검
- 지연 이벤트 정책(allowed lateness) 재검토

<a id="cdc-schema"></a>
## CDC 중단/스키마 비호환
### 탐지
- `cdc.lag_ms.p95` 급증 또는 파이프라인 중단
- 역직렬화 오류율 증가

### 즉시 조치
1. 소비자 배포/스키마 변경을 중단한다.
2. 마지막 정상 오프셋을 고정하고 손상 구간 확산을 막는다.

### 복구
1. 스키마 호환성 위반을 수정 후 재배포.
2. 필요 시 스냅샷 + 오프셋 재동기화로 재구축.
3. 원천-파생 데이터 감사 배치로 정합성 확인.

### 사후 점검
- CI에 스키마 호환성 게이트 강제
- 재처리(runbook) 절차 정기 리허설
